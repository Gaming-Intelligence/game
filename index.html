<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Collector Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script>

        let screen_width;
        let screen_height;
        let coins = [];
        let score = 0;
        let base_radius = 20;
        let backgroundImage;
        let goldCoinImage, silverCoinImage, bronzeCoinImage, newCoinImage;
        let imageLoaded = false;
        let timer = 45; // 45 seconds timer
        let totalCoins = 155;
        let coinsReleased = 0;
        let startTime;
        let gameEnded = false;
        let coinDistribution = {
            silver: 100,
            gold: 50,
            bronze: 6,
            new: 5
        };
        let coinInterval;

        function preload() {
            backgroundImage = loadImage('background.jpg', () => {
                imageLoaded = true; // Set flag to true once the image is loaded
            });

            // Load coin images
            goldCoinImage = loadImage('gi_coin.png');
            silverCoinImage = loadImage('new_coin.png');
            bronzeCoinImage = loadImage('bull_coin.png');
            newCoinImage = loadImage('bear_coin.png'); // Load your new coin image
        }

        function setup() {
            screen_width = windowWidth;
            screen_height = windowHeight;
            createCanvas(screen_width, screen_height);
            textSize(screen_height * 0.05);
            textAlign(LEFT, TOP);

            // Calculate the start time
            startTime = millis();

            // Calculate interval for dropping coins based on the total number of coins and the timer
            coinInterval = (timer * 1000) / totalCoins;
        }

        function draw() {
            if (!imageLoaded) {
                background(50); // Dark background while loading
                fill(255);
                textAlign(CENTER, CENTER);
                textSize(32);
                text('Loading...', screen_width / 2, screen_height / 2);
                return; // Skip the rest of draw until the image is loaded
            }

            image(backgroundImage, 0, 0, screen_width, screen_height);

            // Update the timer
            let elapsed = (millis() - startTime) / 1000;
            let remainingTime = max(0, timer - elapsed).toFixed(2);

            // Drop coins based on the interval
            if (remainingTime > 0 && millis() - startTime >= coinsReleased * coinInterval) {
                let coinType = getNextCoinType();
                if (coinType) {
                    let speedFactor = map(coinsReleased, 0, totalCoins, 1, 2); // Adjust speed to be slower
                    coins.push(new Coin(coinType, speedFactor));
                    coinsReleased++;
                }
            }

            for (let i = coins.length - 1; i >= 0; i--) {
                coins[i].update();
                coins[i].draw();

                if (coins[i].collected || coins[i].y > screen_height + coins[i].radius) {
                    coins.splice(i, 1);
                    if (coinsReleased >= totalCoins && coins.length === 0) {
                        endGame();
                    }
                }
            }

            if (mouseIsPressed) {
                detectSwipe();
            }

            fill(255); // WHITE
            text(`Score: ${score}`, screen_width * 0.02, screen_height * 0.02);
            text(`Time: ${remainingTime}`, screen_width * 0.8, screen_height * 0.02);

            if (remainingTime <= 0 && !gameEnded) {
                endGame();
            }
        }

        function mousePressed() {
            for (let coin of coins) {
                if (coin.isCollected(mouseX, mouseY)) {
                    coin.collected = true;
                    score += coin.value; // Increase the score based on coin value
                }
            }
        }

        function detectSwipe() {
            for (let coin of coins) {
                if (coin.isCollected(mouseX, mouseY)) {
                    coin.collected = true;
                    score += coin.value; // Increase the score based on coin value
                }
            }
        }

        class Coin {
            constructor(coinType, speedFactor) {
                this.radius = base_radius * (screen_height / 600); // Scale radius based on screen height
                this.x = random(this.radius, screen_width - this.radius);
                this.y = -this.radius; // Start above the screen
                this.coinType = coinType;

                if (this.coinType === "gold") {
                    this.image = goldCoinImage;
                    this.value = 5;
                    this.speed = random(2 * speedFactor, 4 * speedFactor); // Adjusted slower speed
                } else if (this.coinType === "silver") {
                    this.image = silverCoinImage;
                    this.value = 3;
                    this.speed = random(1.5 * speedFactor, 3.5 * speedFactor); // Adjusted slower speed
                } else if (this.coinType === "bronze") {
                    this.image = bronzeCoinImage;
                    this.value = 1;
                    this.speed = random(1 * speedFactor, 3 * speedFactor); // Adjusted slower speed
                } else if (this.coinType === "new") {
                    this.image = newCoinImage;
                    this.value = 10;
                    this.speed = random(2.5 * speedFactor, 5 * speedFactor); // Adjusted slower speed
                }

                this.collected = false;
            }

            update() {
                this.y += this.speed * (screen_height / 600); // Move the coin downwards, responsive to screen height
            }

            draw() {
                image(this.image, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
            }

            isCollected(mx, my) {
                let distance = dist(this.x, this.y, mx, my);
                return distance < this.radius;
            }
        }

        function getNextCoinType() {
            let totalDistributed = 0;
            let rand = random(0, totalCoins - coinsReleased);

            for (let type in coinDistribution) {
                totalDistributed += coinDistribution[type];
                if (rand < totalDistributed) {
                    coinDistribution[type]--;
                    return type;
                }
            }
            return null;
        }

        function endGame() {
            noLoop(); // Stop the draw loop
            gameEnded = true;
            fill(255, 0, 0); // RED
            textAlign(CENTER, CENTER);
            textSize(48);
            text('Game Over', screen_width / 2, screen_height / 2);
        }

        function windowResized() {
            screen_width = windowWidth;
            screen_height = windowHeight;
            resizeCanvas(screen_width, screen_height);
            textSize(screen_height * 0.05); // Make the text responsive
        }


    </script>
</body>

</html>