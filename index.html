<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Collector Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>

<body>
    <script>

        let screen_width;
        let screen_height;
        let coins = [];
        let score = 0;
        let base_radius = 25; // Increase base radius for larger coins
        let backgroundImage;
        let goldCoinImage, silverCoinImage, bronzeCoinImage, newCoinImage;
        let imageLoaded = false;
        let totalCoins = 155;
        let coinsReleased = 0;
        let gameEnded = false;
        let freezeTime = 3000; // 3 seconds freeze time
        let isFrozen = false;
        let freezeStart = 0;
        let coinDistribution = {
            silver: 95,
            gold: 50,
            bronze: 6,
            new: 4
        };
        let coinInterval;

        function preload() {
            backgroundImage = loadImage('background.jpg', () => {
                imageLoaded = true; // Set flag to true once the image is loaded
            });

            // Load coin images
            goldCoinImage = loadImage('gi_coin.png');
            silverCoinImage = loadImage('new_coin.png');
            bronzeCoinImage = loadImage('bull_coin.png');
            newCoinImage = loadImage('bear_coin.png'); // Load your new coin image
        }

        function setup() {
            screen_width = windowWidth;
            screen_height = windowHeight;
            createCanvas(screen_width, screen_height);
            textSize(screen_height * 0.05);
            textAlign(LEFT, TOP);

            // Calculate interval for dropping coins based on the total number of coins
            coinInterval = 45 * 1000 / totalCoins; // Use a fixed interval for simplicity
        }

        function draw() {
            if (!imageLoaded) {
                background(50); // Dark background while loading
                fill(255);
                textAlign(CENTER, CENTER);
                textSize(32);
                text('Loading...', screen_width / 2, screen_height / 2);
                return; // Skip the rest of draw until the image is loaded
            }

            // Handle freezing
            if (isFrozen) {
                if (millis() - freezeStart >= freezeTime) {
                    isFrozen = false; // End freeze after 3 seconds
                } else {
                    displayGame(); // Allow coin collection during freeze
                    return; // Skip coin dropping and movement while frozen
                }
            }

            image(backgroundImage, 0, 0, screen_width, screen_height);

            // Drop coins based on the interval
            let currentTime = millis();
            if (coinsReleased < totalCoins && currentTime >= coinsReleased * coinInterval) {
                let coinType = getNextCoinType();
                if (coinType) {
                    // Calculate time remaining for the coin to fall
                    let fallDuration = (screen_height / (screen_height / 45)); // Fixed fall duration
                    let speed = screen_height / fallDuration; // Speed to ensure the coin falls within the duration
                    coins.push(new Coin(coinType, speed));
                    coinsReleased++;
                }
            }

            for (let i = coins.length - 1; i >= 0; i--) {
                coins[i].update();
                coins[i].draw();

                if (coins[i].collected || coins[i].y > screen_height + coins[i].radius) {
                    coins.splice(i, 1);
                    if (coinsReleased >= totalCoins && coins.length === 0 && !gameEnded) {
                        endGame();
                    }
                }
            }

            fill(255); // WHITE
            text(`Score: ${score}`, screen_width * 0.02, screen_height * 0.02);

            if (gameEnded) {
                showGameOverPopup();
            }
        }

        // Use touchStarted instead of mousePressed for mobile compatibility
        function touchStarted() {
            collectCoins();
            return false; // Prevent default behavior
        }

        // Use touchMoved instead of mouseIsPressed for mobile compatibility
        function touchMoved() {
            detectSwipe();
            return false; // Prevent default behavior
        }

        function detectSwipe() {
            collectCoins();
        }

        function collectCoins() {
            for (let i = coins.length - 1; i >= 0; i--) {
                if (coins[i].isCollected(mouseX, mouseY)) {
                    if (coins[i].coinType === "new") {
                        score = Math.floor(score * 0.5); // Deduct 50% of the current score
                    } else {
                        score += coins[i].value; // Increase the score based on coin value
                    }

                    if (coins[i].coinType === "bronze") {
                        triggerFreeze(); // Trigger freeze when bronze coin is collected
                    }
                    coins.splice(i, 1); // Remove collected coin from the array
                }
            }
        }

        function triggerFreeze() {
            isFrozen = true;
            freezeStart = millis();
        }

        class Coin {
            constructor(coinType, speed) {
                this.radius = base_radius * (screen_height / 600); // Scale radius based on screen height
                this.x = random(this.radius, screen_width - this.radius);
                this.y = -this.radius; // Start above the screen
                this.coinType = coinType;

                if (this.coinType === "gold") {
                    this.image = goldCoinImage;
                    this.value = 500;
                } else if (this.coinType === "silver") {
                    this.image = silverCoinImage;
                    this.value = 100;
                } else if (this.coinType === "bronze") {
                    this.image = bronzeCoinImage;
                    this.value = 0;
                } else if (this.coinType === "new") {
                    this.image = newCoinImage;
                    this.value = 0;
                }

                this.speed = speed * 0.3; // Adjusted to slow down the coin drop
                this.collected = false;
            }

            update() {
                this.y += this.speed * (screen_height / 600); // Move the coin downwards, responsive to screen height
            }

            draw() {
                image(this.image, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
            }

            isCollected(mx, my) {
                let touchRadius = this.radius * 1; // Increase touch radius
                let distance = dist(this.x, this.y, mx, my);
                return distance < touchRadius;
            }
        }

        function getNextCoinType() {
            let totalDistributed = 0;
            let rand = random(0, totalCoins - coinsReleased);

            for (let type in coinDistribution) {
                totalDistributed += coinDistribution[type];
                if (rand < totalDistributed) {
                    coinDistribution[type]--;
                    return type;
                }
            }
            return null;
        }

        function endGame() {
            noLoop(); // Stop the draw loop
            gameEnded = true;
        }

        function showGameOverPopup() {
            fill(0, 0, 0, 150); // Semi-transparent background
            rect(0, 0, screen_width, screen_height);

            fill(255); // WHITE
            textAlign(CENTER, CENTER);
            textSize(screen_height * 0.1);
            text('Game Over', screen_width / 2, screen_height / 2 - 50);
            textSize(screen_height * 0.05);
            text(`Score: ${score}`, screen_width / 2, screen_height / 2 + 50);
        }

        function displayGame() {
            image(backgroundImage, 0, 0, screen_width, screen_height);

            for (let i = coins.length - 1; i >= 0; i--) {
                coins[i].draw(); // Only draw coins, no movement during freeze
            }

            fill(255); // WHITE
            text(`Score: ${score}`, screen_width * 0.02, screen_height * 0.02);
        }

        function windowResized() {
            screen_width = windowWidth;
            screen_height = windowHeight;
            resizeCanvas(screen_width, screen_height);
            textSize(screen_height * 0.05); // Make the text responsive
        }

    </script>
</body>

</html>